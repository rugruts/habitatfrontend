import{aq as c,b9 as o}from"./index-DqjjBafN.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const g=c("Key",[["path",{d:"m15.5 7.5 2.3 2.3a1 1 0 0 0 1.4 0l2.1-2.1a1 1 0 0 0 0-1.4L19 4",key:"g0fldk"}],["path",{d:"m21 2-9.6 9.6",key:"1j0ho8"}],["circle",{cx:"7.5",cy:"15.5",r:"5.5",key:"yqb3hr"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const f=c("Smartphone",[["rect",{width:"14",height:"20",x:"5",y:"2",rx:"2",ry:"2",key:"1yt0o3"}],["path",{d:"M12 18h.01",key:"mhygvu"}]]);class u{async getAllTemplates(){const{data:t,error:e}=await o.from("email_templates").select("*").order("created_at",{ascending:!1});if(e)throw console.error("Error fetching email templates:",e),new Error(`Failed to fetch email templates: ${e.message}`);return t||[]}async getActiveTemplates(){const{data:t,error:e}=await o.from("email_templates").select("*").eq("is_active",!0).order("created_at",{ascending:!1});if(e)throw console.error("Error fetching active email templates:",e),new Error(`Failed to fetch active email templates: ${e.message}`);return t||[]}async getTemplateById(t){const{data:e,error:a}=await o.from("email_templates").select("*").eq("id",t).single();if(a){if(a.code==="PGRST116")return null;throw console.error("Error fetching email template:",a),new Error(`Failed to fetch email template: ${a.message}`)}return e}async getTemplateByType(t){const{data:e,error:a}=await o.from("email_templates").select("*").eq("template_type",t).eq("is_active",!0).single();if(a){if(a.code==="PGRST116")return null;throw console.error("Error fetching email template by type:",a),new Error(`Failed to fetch email template: ${a.message}`)}return e}async createTemplate(t){const{data:e,error:a}=await o.from("email_templates").insert([{...t,is_active:t.is_active??!0,variables:t.variables||[]}]).select().single();if(a)throw console.error("Error creating email template:",a),new Error(`Failed to create email template: ${a.message}`);return e}async updateTemplate(t){const{id:e,...a}=t,{data:r,error:s}=await o.from("email_templates").update(a).eq("id",e).select().single();if(s)throw console.error("Error updating email template:",s),new Error(`Failed to update email template: ${s.message}`);return r}async deleteTemplate(t){const{error:e}=await o.from("email_templates").delete().eq("id",t);if(e)throw console.error("Error deleting email template:",e),new Error(`Failed to delete email template: ${e.message}`)}async toggleTemplateStatus(t,e){const{data:a,error:r}=await o.from("email_templates").update({is_active:e}).eq("id",t).select().single();if(r)throw console.error("Error toggling template status:",r),new Error(`Failed to toggle template status: ${r.message}`);return a}async getEmailLogs(t=50,e=0){const{data:a,error:r}=await o.from("email_logs").select("*").order("sent_at",{ascending:!1}).range(e,e+t-1);if(r)throw console.error("Error fetching email logs:",r),new Error(`Failed to fetch email logs: ${r.message}`);return a||[]}async resendEmail(t){try{console.log("üîÑ Resending email from log:",t);const{data:e,error:a}=await o.from("email_logs").select("*").eq("id",t).single();if(a)throw console.error("Error fetching email log:",a),new Error(`Failed to fetch email log: ${a.message}`);if(!e)throw new Error("Email log not found");const{data:r,error:s}=await o.from("email_logs").insert({template_id:e.template_id,recipient_email:e.recipient_email,recipient_name:e.recipient_name,subject:`[RESENT] ${e.subject}`,content:e.content,status:"pending",booking_id:e.booking_id,guest_id:e.guest_id,metadata:{...e.metadata,resent_from:t,resent_at:new Date().toISOString(),is_manual_resend:!0}}).select().single();if(s)throw console.error("Error creating resend email log:",s),new Error(`Failed to create resend log: ${s.message}`);try{const i=await fetch("https://backendhabitatapi.vercel.app/api/send-email",{method:"POST",headers:{"Content-Type":"application/json","x-api-key":"habitat_lobby_2024_86abfb60f093d26335ebc1f3b028f254"},body:JSON.stringify({to:e.recipient_email,toName:e.recipient_name,subject:`[RESENT] ${e.subject}`,htmlBody:e.content,metadata:{...e.metadata,resent_from:t,is_manual_resend:!0}})});if(i.ok)return await o.from("email_logs").update({status:"sent",sent_at:new Date().toISOString()}).eq("id",r.id),console.log("‚úÖ Email resent successfully"),{success:!0,message:"Email resent successfully"};{const l=await i.text();throw new Error(`Backend API error: ${l}`)}}catch(i){return console.error("API send failed, updating log as failed:",i),await o.from("email_logs").update({status:"failed",error_message:i instanceof Error?i.message:"Unknown API error"}).eq("id",r.id),{success:!1,message:`Failed to send email: ${i instanceof Error?i.message:"Unknown error"}`}}}catch(e){return console.error("‚ùå Error resending email:",e),{success:!1,message:e instanceof Error?e.message:"Unknown error occurred"}}}async logEmail(t){const{data:e,error:a}=await o.from("email_logs").insert([t]).select().single();if(a)throw console.error("Error logging email:",a),new Error(`Failed to log email: ${a.message}`);return e}processTemplate(t,e){let a=t;return Object.entries(e).forEach(([r,s])=>{const i=new RegExp(`{{${r}}}`,"g");a=a.replace(i,String(s||""))}),a}extractVariables(t){const e=/{{(\w+)}}/g,a=[];let r;for(;(r=e.exec(t))!==null;)a.includes(r[1])||a.push(r[1]);return a}}const n=new u;class _{async getAllAutomations(){const{data:t,error:e}=await o.from("email_automations").select("*").order("created_at",{ascending:!1});if(e)throw console.error("Error fetching automations:",e),new Error(`Failed to fetch automations: ${e.message}`);return t||[]}async getActiveAutomations(){const{data:t,error:e}=await o.from("email_automations").select("*").eq("is_active",!0).order("created_at",{ascending:!1});if(e)throw console.error("Error fetching active automations:",e),new Error(`Failed to fetch active automations: ${e.message}`);return t||[]}async createAutomation(t){const{data:e,error:a}=await o.from("email_automations").insert([t]).select().single();if(a)throw console.error("Error creating automation:",a),new Error(`Failed to create automation: ${a.message}`);return e}async updateAutomation(t,e){const{data:a,error:r}=await o.from("email_automations").update(e).eq("id",t).select().single();if(r)throw console.error("Error updating automation:",r),new Error(`Failed to update automation: ${r.message}`);return a}async deleteAutomation(t){const{error:e}=await o.from("email_automations").delete().eq("id",t);if(e)throw console.error("Error deleting automation:",e),new Error(`Failed to delete automation: ${e.message}`)}async processAutomationTrigger(t){console.log("üîÑ Processing automation trigger:",t);try{const e=await this.getActiveAutomations();for(const a of e)this.shouldTriggerAutomation(a,t)&&await this.executeAutomation(a,t)}catch(e){throw console.error("‚ùå Error processing automation trigger:",e),e}}shouldTriggerAutomation(t,e){return!(t.conditions&&(t.conditions.booking_status&&!t.conditions.booking_status.includes(e.booking_status)||t.conditions.property_ids&&!t.conditions.property_ids.includes(e.property_id)||t.conditions.guest_count_min&&e.guest_count<t.conditions.guest_count_min||t.conditions.guest_count_max&&e.guest_count>t.conditions.guest_count_max))}async executeAutomation(t,e){try{console.log(`üìß Executing automation: ${t.name}`);const a=await n.getTemplateById(t.template_id);if(!a){console.error(`Template not found for automation: ${t.id}`);return}const r={customer_name:e.guest_name||"Guest",property_name:e.property_name,check_in:e.check_in,check_out:e.check_out,guests:e.guest_count,total_amount:e.total_amount,booking_id:e.booking_id,business_name:"Habitat Lobby",business_email:"info@habitatlobby.com",business_phone:"+30 243 123 4567",business_address:"Alexandrias 69, Trikala, Greece",review_url:`${window.location.origin}/review/${e.booking_id}`,booking_url:`${window.location.origin}/booking/${e.booking_id}`,property_url:`${window.location.origin}/apartment/${e.property_id}`},s=n.processTemplate(a.subject,r),i=n.processTemplate(a.content,r),l=await fetch("https://backendhabitatapi.vercel.app/api/send-email",{method:"POST",headers:{"Content-Type":"application/json","x-api-key":"habitat_lobby_2024_86abfb60f093d26335ebc1f3b028f254"},body:JSON.stringify({to:e.guest_email,toName:e.guest_name,subject:s,htmlBody:i,metadata:{automation_id:t.id,trigger_type:t.trigger_type,booking_id:e.booking_id,property_id:e.property_id}})});if(l.ok)await n.logEmail({template_id:a.id,recipient_email:e.guest_email,recipient_name:e.guest_name,subject:s,content:i,status:"sent",booking_id:e.booking_id,sent_at:new Date().toISOString(),metadata:{automation_id:t.id,trigger_type:t.trigger_type,property_id:e.property_id}}),await this.updateAutomation(t.id,{last_triggered_at:new Date().toISOString(),total_triggered:t.total_triggered+1}),console.log(`‚úÖ Automation executed successfully: ${t.name}`);else{const d=await l.text();throw new Error(`Backend API error: ${d}`)}}catch(a){throw console.error(`‚ùå Error executing automation ${t.name}:`,a),await n.logEmail({template_id:t.template_id,recipient_email:e.guest_email,recipient_name:e.guest_name,subject:"Email Failed",content:"Email content not available",status:"failed",booking_id:e.booking_id,sent_at:new Date().toISOString(),error_message:a instanceof Error?a.message:"Unknown error",metadata:{automation_id:t.id,trigger_type:t.trigger_type,property_id:e.property_id}}),a}}async scheduleDelayedEmail(t,e,a){const r=new Date;r.setHours(r.getHours()+a),console.log(`‚è∞ Scheduling delayed email for ${r.toISOString()}`);const{error:s}=await o.from("scheduled_emails").insert({automation_id:t.id,booking_id:e.booking_id,guest_email:e.guest_email,guest_name:e.guest_name,scheduled_for:r.toISOString(),status:"scheduled",metadata:{trigger_type:t.trigger_type,property_id:e.property_id,property_name:e.property_name,check_in:e.check_in,check_out:e.check_out,guest_count:e.guest_count,total_amount:e.total_amount}});if(s)throw console.error("Error scheduling delayed email:",s),new Error(`Failed to schedule email: ${s.message}`)}async processScheduledEmails(){const t=new Date,{data:e,error:a}=await o.from("scheduled_emails").select("*").eq("status","scheduled").lte("scheduled_for",t.toISOString());if(a){console.error("Error fetching scheduled emails:",a);return}for(const r of e||[])try{const s=await this.getAutomationById(r.automation_id);if(!s)continue;const i={booking_id:r.booking_id,guest_email:r.guest_email,guest_name:r.guest_name,property_name:r.metadata.property_name,check_in:r.metadata.check_in,check_out:r.metadata.check_out,guest_count:r.metadata.guest_count,total_amount:r.metadata.total_amount,booking_status:"confirmed",property_id:r.metadata.property_id};await this.executeAutomation(s,i),await o.from("scheduled_emails").update({status:"sent",sent_at:new Date().toISOString()}).eq("id",r.id)}catch(s){console.error("Error processing scheduled email:",s),await o.from("scheduled_emails").update({status:"failed",error_message:s instanceof Error?s.message:"Unknown error"}).eq("id",r.id)}}async getAutomationById(t){const{data:e,error:a}=await o.from("email_automations").select("*").eq("id",t).single();if(a){if(a.code==="PGRST116")return null;throw console.error("Error fetching automation:",a),new Error(`Failed to fetch automation: ${a.message}`)}return e}}const h=new _;export{g as K,f as S,n as a,h as e};
