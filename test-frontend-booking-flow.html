<!DOCTYPE html>
<html>
<head>
    <title>Frontend Booking Flow Test</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .test { margin: 10px 0; padding: 10px; border: 1px solid #ccc; }
        .success { background: #d4edda; border-color: #c3e6cb; }
        .error { background: #f8d7da; border-color: #f5c6cb; }
        button { padding: 10px 20px; margin: 5px; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 4px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>üß™ Frontend Booking Flow Test</h1>
    
    <button onclick="testEmailServiceClass()">Test EmailService Class</button>
    <button onclick="testBookingConfirmation()">Test Booking Confirmation</button>
    
    <div id="results"></div>

    <script>
        // Simulate the frontend EmailService class
        class EmailService {
            constructor(fromEmail = 'noreply@habitatlobby.com', fromName = 'Habitat Lobby') {
                this.fromEmail = fromEmail;
                this.fromName = fromName;
                this.apiUrl = 'http://localhost:3001/api/email';
                this.apiKey = 'habitat_lobby_secure_api_key_2024';
            }

            async sendBookingConfirmation(bookingId) {
                try {
                    console.log('üîÑ Attempting to send booking confirmation email for booking:', bookingId);
                    
                    // Simulate getting booking from database (this would be the real booking data)
                    const booking = {
                        id: bookingId,
                        customer_name: 'Test User',
                        customer_email: 'theo.matrapilias@outlook.com',
                        check_in: '2024-08-15',
                        check_out: '2024-08-18',
                        guests: 2,
                        total_amount: 220.00,
                        properties: {
                            name: 'Apartment 1 - with View'
                        }
                    };

                    console.log('üìß Email service result: Calling backend API...');

                    const response = await fetch(`${this.apiUrl}/send-booking-confirmation`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'x-api-key': this.apiKey
                        },
                        body: JSON.stringify({
                            booking: booking
                        })
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || `HTTP ${response.status}`);
                    }

                    const result = await response.json();
                    
                    return {
                        success: true,
                        messageId: result.messageId
                    };

                } catch (error) {
                    console.error('üí• Email service error:', error);
                    return {
                        success: false,
                        error: error.message
                    };
                }
            }
        }

        // Create emailService instance (like in the frontend)
        const emailService = new EmailService('info@habitat-lobby.com', 'Habitat Lobby');

        function addResult(title, success, message) {
            const div = document.createElement('div');
            div.className = `test ${success ? 'success' : 'error'}`;
            div.innerHTML = `<h3>${title}</h3><pre>${message}</pre>`;
            document.getElementById('results').appendChild(div);
        }

        async function testEmailServiceClass() {
            try {
                addResult('EmailService Class Test', true, 
                    `‚úÖ EmailService instantiated successfully
API URL: ${emailService.apiUrl}
API Key: ${emailService.apiKey}
From Email: ${emailService.fromEmail}`);
            } catch (error) {
                addResult('EmailService Class Test', false, `‚ùå ${error.message}`);
            }
        }

        async function testBookingConfirmation() {
            const bookingId = '4031CCE3-frontend-flow-test';
            
            try {
                console.log('üîÑ Testing booking confirmation flow...');
                const result = await emailService.sendBookingConfirmation(bookingId);
                
                if (result.success) {
                    addResult('Booking Confirmation Test', true, 
                        `‚úÖ Email sent successfully!
Message ID: ${result.messageId}
Booking ID: ${bookingId}

Check your email inbox!`);
                } else {
                    addResult('Booking Confirmation Test', false, 
                        `‚ùå Email failed to send: ${result.error}`);
                }
            } catch (error) {
                addResult('Booking Confirmation Test', false, `‚ùå ${error.message}`);
            }
        }
    </script>
</body>
</html>
